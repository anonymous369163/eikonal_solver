# SAMRoute config — Phase 1 with NORMALIZED road masks (skeletonize + dilate r=8)
#
# Key differences from config_sam_route_demo.yaml:
#   - Used with: --road_dilation_radius 8
#   - r=8 makes roads 17px wide >= SAM feature stride (16px), so every road is
#     fully covered by at least one feature cell → encoder can encode road location
#   - ROAD_POS_WEIGHT=2.5 (density ~28% with r=8)
#   - ENCODER_LORA=True: fine-tune SAM QKV for road-specific features
#   - Dice loss: directly optimises IoU overlap
#   - Run first: python eikonal_solver/precompute_normalized_masks.py --radius 8

# ---- SAM backbone ----
NO_SAM: False
SAM_VERSION: 'vit_b'
SAM_CKPT_PATH: '../sam_road_repo/sam_ckpts/sam_vit_b_01ec64.pth'

# Optional: fine-tune from an existing SAMRoad checkpoint (comment out to train from scratch)
PRETRAINED_CKPT: '../checkpoints/cityscale_vitb_512_e10.ckpt'

# ---- Input ----
PATCH_SIZE: 512

# ---- Training ----
BATCH_SIZE: 4
DATA_WORKER_NUM: 24
TRAIN_EPOCHS: 10
BASE_LR: 0.0003
FREEZE_ENCODER: False       # LoRA overrides; don't freeze when ENCODER_LORA=True
ENCODER_LR_FACTOR: 0.1
ENCODER_LORA: True          # LoRA adapters on encoder QKV: ~0.3M extra params to learn road features
LORA_RANK: 4                # low-rank dimension for LoRA adapters
FOCAL_LOSS: False
USE_SAM_DECODER: False

# ---- SAMRoute-specific ----
# Phase 1: seg only — set ROUTE_LAMBDA_DIST: 0.0
# Phase 2: enable distance loss — set ROUTE_LAMBDA_DIST: 1.0
ROUTE_LAMBDA_SEG: 1.0
ROUTE_LAMBDA_DIST: 0.0

# LR schedule: decay at epoch 150 (not epoch 9)
LR_MILESTONES: [150]

# Class imbalance compensation — calibrated for normalized masks (r=8, density ~28%).
# pos_weight = (1 - 0.28) / 0.28 ≈ 2.5
ROAD_POS_WEIGHT: 2.5

# Dice loss weight (0.0=pure BCE, 1.0=pure Dice).
# With dual-target: BCE uses thick mask for recall, Dice uses thin mask for sharpness.
# 0.5 = best balance; 0.8 was tested and is too aggressive (pushes model beyond
# feature resolution limits, Spearman drops significantly).
ROAD_DICE_WEIGHT: 0.5

# Dual-target training: BCE uses thick mask (r=8) for recall,
# Dice uses ORIGINAL thin mask for boundary sharpness.
# This produces road_prob that is both complete AND sharp-edged —
# ideal for Eikonal cost fields that need precise gradients.
ROAD_DUAL_TARGET: True

# Cost function mode for Eikonal ("exp" | "add")
ROUTE_COST_MODE: 'add'
ROUTE_ADD_ALPHA: 20.0
ROUTE_ADD_GAMMA: 2.0
ROUTE_ADD_BLOCK_ALPHA: 50.0
ROUTE_ADD_BLOCK_SMOOTH: 50.0

# ---- Inference thresholds (kept for compatibility) ----
ITSC_THRESHOLD: 0.248
ROAD_THRESHOLD: 0.364
TOPO_THRESHOLD: 0.500
ITSC_NMS_RADIUS: 8
ROAD_NMS_RADIUS: 16
NEIGHBOR_RADIUS: 64
MAX_NEIGHBOR_QUERIES: 16
INFER_BATCH_SIZE: 64
SAMPLE_MARGIN: 64
INFER_PATCHES_PER_EDGE: 8

# ---- Unused by SAMRoute but required by SAMRoad parent __init__ ----
TOPO_SAMPLE_NUM: 512
TOPONET_VERSION: 'normal'
DATASET: 'mmroute'

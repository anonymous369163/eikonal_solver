# SAMRoute config — Phase 2: distance supervision on top of Phase 1 dual-target
#
# Fine-tune from Phase 1 checkpoint (r=5 dual-target, Dice=0.5).
# Adds Eikonal distance loss to improve Spearman ranking.
# Encoder frozen (no LoRA) — fast training, same speed as Phase 1.
#
# Usage:
#   bash eikonal_solver/run_train.sh --phase 2 --epochs 100

# ---- SAM backbone ----
NO_SAM: False
SAM_VERSION: 'vit_b'
SAM_CKPT_PATH: '../sam_road_repo/sam_ckpts/sam_vit_b_01ec64.pth'

# Phase 1 best checkpoint as starting point (update after Phase 1 r=5 training)
PRETRAINED_CKPT: 'training_outputs/phase1_r5_seg/checkpoints/samroute-epoch=57-val_seg_loss=0.6815.ckpt'

# ---- Input ----
PATCH_SIZE: 512

# ---- Training ----
BATCH_SIZE: 4
DATA_WORKER_NUM: 24
TRAIN_EPOCHS: 100
BASE_LR: 0.0001              # lower LR for Phase 2 fine-tuning
FREEZE_ENCODER: True
ENCODER_LR_FACTOR: 0.1
ENCODER_LORA: False
FOCAL_LOSS: False
USE_SAM_DECODER: False

# ---- Loss weights ----
ROUTE_LAMBDA_SEG: 1.0
ROUTE_LAMBDA_DIST: 0.1       # dist_loss converges to ~0.1-1.0 after normalisation by 512;
                              # 0.1*0.5 = 0.05 keeps distance supervision meaningful (~20-50% of seg_loss)

# LR schedule: decay at epoch 80
LR_MILESTONES: [80]

# ---- Segmentation loss (dual-target from Phase 1) ----
ROAD_POS_WEIGHT: 3.7          # ~21% road density with dilation r=5
ROAD_DICE_WEIGHT: 0.5
ROAD_DUAL_TARGET: True

# ---- Eikonal solver (distance supervision) ----
# ds and n_iters are now DECOUPLED. ds=8 is fixed; n_iters controls convergence only.
# Ablation showed: ds=8 (Pc~94) converges at n_iters~40, giving Sp~0.756 on GT masks.
ROUTE_EIK_ITERS: 40
ROUTE_CKPT_CHUNK: 5
ROUTE_ROI_MARGIN: 64
ROUTE_EIK_DOWNSAMPLE: 8            # fixed grid resolution (decoupled from n_iters)
ROUTE_K_TARGETS: 4
ROUTE_MIN_IN_PATCH: 2

# Stabilisation
ROUTE_DIST_WARMUP_STEPS: 300
ROUTE_EIK_WARMUP_EPOCHS: 3
ROUTE_EIK_ITERS_MIN: 10
ROUTE_DIST_NORM_PX: 512.0
ROUTE_GATE_ALPHA: 0.95

# Cost function mode for Eikonal ("exp" | "add")
ROUTE_COST_MODE: 'add'
ROUTE_ADD_ALPHA: 20.0
ROUTE_ADD_GAMMA: 2.0
ROUTE_ADD_BLOCK_ALPHA: 50.0
ROUTE_ADD_BLOCK_SMOOTH: 50.0

# ---- Inference thresholds (kept for compatibility) ----
ITSC_THRESHOLD: 0.248
ROAD_THRESHOLD: 0.364
TOPO_THRESHOLD: 0.500
ITSC_NMS_RADIUS: 8
ROAD_NMS_RADIUS: 16
NEIGHBOR_RADIUS: 64
MAX_NEIGHBOR_QUERIES: 16
INFER_BATCH_SIZE: 64
SAMPLE_MARGIN: 64
INFER_PATCHES_PER_EDGE: 8

# ---- Unused by SAMRoute but required by SAMRoad parent __init__ ----
TOPO_SAMPLE_NUM: 512
TOPONET_VERSION: 'normal'
DATASET: 'mmroute'

# SAMRoute training config — Phase 2: road segmentation + distance supervision
#
# Requires --include_dist flag when launching train_sam_route.py.
# Typically fine-tuned from a Phase 1 checkpoint via --ckpt_path.

# ---- SAM backbone ----
NO_SAM: False
SAM_VERSION: 'vit_b'
SAM_CKPT_PATH: '../sam_road_repo/sam_ckpts/sam_vit_b_01ec64.pth'

# Optional: fine-tune from an existing SAMRoad checkpoint
PRETRAINED_CKPT: '../checkpoints/cityscale_vitb_512_e10.ckpt'

# ---- Input ----
PATCH_SIZE: 512

# ---- Training ----
BATCH_SIZE: 4
DATA_WORKER_NUM: 6
TRAIN_EPOCHS: 20
BASE_LR: 0.0001              # lower LR for Phase 2 stability
FREEZE_ENCODER: True
ENCODER_LR_FACTOR: 0.1
ENCODER_LORA: False
FOCAL_LOSS: False
USE_SAM_DECODER: False

# ---- SAMRoute-specific ----
ROUTE_LAMBDA_SEG: 1.0
ROUTE_LAMBDA_DIST: 0.01      # scaled down: normalised dist_loss ~30, so 0.01*30≈0.3 ≈ seg_loss

# Eikonal solver
ROUTE_EIK_ITERS: 20            # 20 iters + ds≥8 → coarse grid ~19×19; best Spearman/speed tradeoff
ROUTE_CKPT_CHUNK: 5            # checkpoint every 5 iters (was 10, halved to match new iter count)
ROUTE_ROI_MARGIN: 64

# GPPN-inspired stabilisation
ROUTE_DIST_WARMUP_STEPS: 300   # linear warmup of lambda_dist over this many steps
ROUTE_EIK_WARMUP_EPOCHS: 3     # ramp eikonal iters from min to full over N epochs
ROUTE_EIK_ITERS_MIN: 10        # starting iteration count during warmup (was 60, scaled to new max=20)
ROUTE_DIST_NORM_PX: 512.0      # normalise distances (pred & gt) by this before loss
ROUTE_GATE_ALPHA: 0.95          # GPPN-style residual gate (1.0=off, <1.0=blend; 0.95 is gentler)
ROUTE_EIK_DOWNSAMPLE: 8        # adaptive ds≥8: coarse grid ≈19×19, ~5× faster than ds≥4/100-iters
ROUTE_K_TARGETS: 4             # supervise K nearest-neighbor targets per anchor per Eikonal solve
ROUTE_MIN_IN_PATCH: 2          # anchor retry until ≥ this many neighbors are in the patch

# Cost function mode for Eikonal ("exp" | "add")
ROUTE_COST_MODE: 'add'
ROUTE_ADD_ALPHA: 20.0
ROUTE_ADD_GAMMA: 2.0
ROUTE_ADD_BLOCK_ALPHA: 50.0
ROUTE_ADD_BLOCK_SMOOTH: 50.0

# ---- Inference thresholds (kept for compatibility) ----
ITSC_THRESHOLD: 0.248
ROAD_THRESHOLD: 0.364
TOPO_THRESHOLD: 0.500
ITSC_NMS_RADIUS: 8
ROAD_NMS_RADIUS: 16
NEIGHBOR_RADIUS: 64
MAX_NEIGHBOR_QUERIES: 16
INFER_BATCH_SIZE: 64
SAMPLE_MARGIN: 64
INFER_PATCHES_PER_EDGE: 8

# ---- Unused by SAMRoute but required by SAMRoad parent __init__ ----
TOPO_SAMPLE_NUM: 512
TOPONET_VERSION: 'normal'
DATASET: 'mmroute'

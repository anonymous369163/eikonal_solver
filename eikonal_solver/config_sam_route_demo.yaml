# SAMRoute training demo config — Phase 1: road segmentation only
# Phase 2 (distance supervision) can be enabled by setting ROUTE_LAMBDA_DIST > 0
# and passing include_dist=True to the dataset builder.

# ---- SAM backbone ----
NO_SAM: False
SAM_VERSION: 'vit_b'
SAM_CKPT_PATH: '../sam_road_repo/sam_ckpts/sam_vit_b_01ec64.pth'

# Optional: fine-tune from an existing SAMRoad checkpoint (comment out to train from scratch)
PRETRAINED_CKPT: '../checkpoints/cityscale_vitb_512_e10.ckpt'

# ---- Input ----
PATCH_SIZE: 512

# ---- Training ----
BATCH_SIZE: 4
DATA_WORKER_NUM: 24
TRAIN_EPOCHS: 10
BASE_LR: 0.0003
FREEZE_ENCODER: True        # freeze SAM image encoder; only train the map decoder
ENCODER_LR_FACTOR: 0.1
ENCODER_LORA: False
FOCAL_LOSS: False
USE_SAM_DECODER: False

# ---- SAMRoute-specific ----
# Phase 1: seg only — set ROUTE_LAMBDA_DIST: 0.0
# Phase 2: enable distance loss — set ROUTE_LAMBDA_DIST: 1.0
ROUTE_LAMBDA_SEG: 1.0
ROUTE_LAMBDA_DIST: 0.0

# LR schedule: MultiStepLR milestones (epoch indices). Original SAMRoad used [9]
# which decays too early.  [150] keeps full LR for most of 200-epoch training.
LR_MILESTONES: [150]

# Class imbalance compensation for road segmentation loss.
# Road pixels are ~6-7% of each patch; without this, BCEWithLogitsLoss drives the
# model to predict all-background, collapsing IoU to ~0.03 in epoch 1.
# pos_weight ≈ (1 - road_density) / road_density
#   Original masks (~6.7% road): pos_weight ≈ 13.9
#   Normalized masks r=3 (~8.3% road): pos_weight ≈ 11.0  ← use this when --road_dilation_radius 3
# Set to 1.0 to disable (original behavior, not recommended).
ROAD_POS_WEIGHT: 13.9  # override to 11.0 when using --road_dilation_radius 3

# Dice loss weight (0.0 = pure BCE, 0.5 = equal mix, 1.0 = pure Dice).
# Dice directly optimises IoU overlap; prevents the "confidence calibration plateau"
# where BCE loss keeps dropping but binary IoU stays flat.
ROAD_DICE_WEIGHT: 0.5

# Cost function mode for Eikonal ("exp" | "add")
ROUTE_COST_MODE: 'add'
ROUTE_ADD_ALPHA: 20.0
ROUTE_ADD_GAMMA: 2.0
ROUTE_ADD_BLOCK_ALPHA: 50.0
ROUTE_ADD_BLOCK_SMOOTH: 50.0

# ---- Inference thresholds (kept for compatibility) ----
ITSC_THRESHOLD: 0.248
ROAD_THRESHOLD: 0.364
TOPO_THRESHOLD: 0.500
ITSC_NMS_RADIUS: 8
ROAD_NMS_RADIUS: 16
NEIGHBOR_RADIUS: 64
MAX_NEIGHBOR_QUERIES: 16
INFER_BATCH_SIZE: 64
SAMPLE_MARGIN: 64
INFER_PATCHES_PER_EDGE: 8

# ---- Unused by SAMRoute but required by SAMRoad parent __init__ ----
TOPO_SAMPLE_NUM: 512
TOPONET_VERSION: 'normal'
DATASET: 'mmroute'
